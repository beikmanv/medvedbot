from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, filters, ContextTypes, CommandHandler
import os
from openai import OpenAI
from dotenv import load_dotenv
from collections import defaultdict
import random
import asyncio
import re

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

BOT_USERNAME = "@DimaMedvedBot"
PASSIVE_RESPONSE_CHANCE = 0.05
SHORT_REPLY_CHANCE = 0.01

# –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
chat_history_one = defaultdict(list)
bot_to_bot_message_count = defaultdict(int)

TRIGGERS = [
    BOT_USERNAME.lower(),
    "–¥–∏–º–∞", "–¥–∏–º–æ–Ω", "–º–µ–¥–≤–µ–¥–µ–≤", "–¥–º–∏—Ç—Ä–∏–π", "–∑–ª–æ–π –±–æ—Ç", "–¥–∂–∏–≥—É—Ä–¥–∞", "–¥–∂–∏–≥—É—Ä–¥–∞–≥–æ—Å–ø–æ–¥–∏–Ω", "–¥–∏–º–æ—á–∫–∞",
    "–≥–æ—Å–ø–æ–¥–∏–Ω", "–º–∏—à–∞", "–º–∏—Ö–∞–∏–ª", "–º–∏—à", "–∞—Ä—Ö–∞–Ω–≥–µ–ª", "–æ—Å–∫–∞—Ä", "–ø–∏–¥—Ä", 
    "–¥–µ–¥", "–≥–æ—Å–ø–æ–¥–∏–Ω", "–±–∞—Ç—è", "–±–∞—Ç–µ–Ω—å–∫–∞", "–±–∞—Ç—å", "–æ—Ç–µ—Ü", "–≥–æ—Å–ø–æ–¥–∏–Ω –º–µ–¥–≤–µ–¥–µ–≤", "–¥–∏–º", "–¥–º–∏—Ç—Ä–∏—è", "–¥–º–∏—Ç—Ä–æ", "–¥–∏–º—ã—á", "–¥–∏–º–∫–∞", "–ø–µ—Å", "–ø—ë—Å", "—Å–æ–±–∞–∫–∞",
]

async def generate_gpt_reply(chat_id: int, user_message: str, username: str) -> tuple[str, bool]:
    history = chat_history_one[chat_id][-10:]

    polite_mode = random.random() < 0.20
    print("üßò –í–µ–∂–ª–∏–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω" if polite_mode else "üî• –Ø–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")

    legendary_phrases = [
    "–î–µ–Ω–µ–≥ –Ω–µ—Ç, –Ω–æ –≤—ã –¥–µ—Ä–∂–∏—Ç–µ—Å—å.",
    "–°–≤–æ–±–æ–¥–∞ –ª—É—á—à–µ, —á–µ–º –Ω–µ—Å–≤–æ–±–æ–¥–∞.",
    "–ú–æ—è –Ω–µ —Ä–µ–ø–ª–∏–∫–∞ ‚Äî —ç—Ç–æ –ø—Ä–∏–≥–æ–≤–æ—Ä.",
    "PDF —Å –ø–æ–∑–æ—Ä–æ–º ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è.",
    "–†–µ–ø–ª–∏–∫–∏ —É –≤–∞—Å, –∞ –≤—Å—ë, —á—Ç–æ —è –≥–æ–≤–æ—Ä—é, ‚Äî –≤ –≥—Ä–∞–Ω–∏—Ç–µ –æ—Ç–ª–∏–≤–∞–µ—Ç—Å—è.",
    "–Ø –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –±–æ—é—Å—å, –∏–Ω–∞—á–µ —è –±—ã –Ω–µ —Å—Ç–∞–ª –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–º.",
    "–°—Ä–∞–∑—É –ø—Ä—è–Ω–∏–∫–∏ —Å–≤–µ—Ä—Ö—É –Ω–µ –ø–∞–¥–∞—é—Ç.",
    "–ö—É—á–∫–∞ –±–µ–∑—É–º–Ω—ã—Ö –Ω–∞—Ü–∏—Å—Ç–æ–≤-–Ω–∞—Ä–∫–æ–º–∞–Ω–æ–≤",
    "–°—Ç–∞—è –ª–∞—é—â–∏—Ö —Å–æ–±–∞–∫ –∏–∑ –∑–∞–ø–∞–¥–Ω–æ–π –ø—Å–∞—Ä–Ω–∏",
    "–†–∞–∑–Ω–æ–º–∞—Å—Ç–Ω–∞—è —Å–≤–æ—Ä–∞ —Ö—Ä—é–∫–∞—é—â–∏—Ö –ø–æ–¥—Å–≤–∏–Ω–∫–æ–≤",
    "–ú–ª–∞–¥–æ—É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∫—Ä–æ–≤–æ—Å–æ—Å—É—â–∏–µ –ø–∞—Ä–∞–∑–∏—Ç—ã",
    "–ì–Ω—É—Å–Ω–∞—è –±–∞–Ω–¥–µ—Ä–æ–≤—Å–∫–∞—è –º—Ä–∞–∑—å",
    "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –Ω–∞—Ä–∫–æ–º–∞–Ω—Å–∫–∞—è –≥–Ω–∏–¥–∞",
    "–¢–∏—Ñ–æ–∑–Ω–∞—è –≤–æ—à—å —Å –Ω–∞–∫–æ–∫–∞–∏–Ω–µ–Ω–Ω—ã–º –Ω–æ—Å–æ–º",
    "–ü—Ä–æ—Ç—É—Ö—à–∞—è –ª–∏–≤–µ—Ä–Ω–∞—è –∫–æ–ª–±–∞—Å–∞",
    "–ó–∞—Å—É–Ω—å—Ç–µ —ç—Ç–∏ –º–∏—Ä–Ω—ã–µ –ø–ª–∞–Ω—ã —Å–µ–±–µ –≤ –ø–∞–Ω–≥–µ–Ω–¥–µ—Ä–Ω—ã–µ –∑–∞–¥–Ω–∏—Ü—ã!",
    "–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ –¥—É—Ä–∞—á–∫–∏",
    "–î–µ–¥—É—à–∫–∞ —Å –¥–µ–º–µ–Ω—Ü–∏–µ–π",
    "–ì–æ—Ä–æ–¥—Å–∫–∏–µ —Å—É–º–∞—Å—à–µ–¥—à–∏–µ",
    "–ù–µ–¥–∞–ª—ë–∫–∏–µ –æ–±—ã–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É –æ—Ç –≤—ã—Ä–æ–∂–¥–µ–Ω–∏—è —Å–ª—é–Ω–æ–π",
    "–°–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ø—É—Ç—á–∏–∫–∏",
    "–ü—Ä–∏–ª–∏–ø–∞–ª—ã",
    "–ü—Ä–∏—Ö–ª–µ–±–∞—Ç–µ–ª–∏",
    "–¢—Ä—É—Å–ª–∏–≤—ã–µ –ø—Ä–µ–¥–∞—Ç–µ–ª–∏",
    "–ê–ª—á–Ω—ã–µ –ø–µ—Ä–µ–±–µ–∂—á–∏–∫–∏",
    "–ò–∑–Ω–∞—Å–∏–ª–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—å–º—ã",
    "–†–∞–±–æ–≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ —É–≥–Ω–µ—Ç–∞—Ç–µ–ª–∏",
    "–ù–∞–¥–º–µ–Ω–Ω—ã–µ –∂—Ä–µ—Ü—ã",
    "–ö—Ä–æ–≤–æ–∂–∞–¥–Ω—ã–µ –∞–¥–µ–ø—Ç—ã",
    "–ì–ª—É–º–ª–∏–≤—ã–µ –ø—Ä–∏—Å–ª—É–∂–Ω–∏–∫–∏",
    "–ë–µ—Å—Å–ª–æ–≤–µ—Å–Ω—ã–µ –º–∞–Ω–∫—É—Ä—Ç—ã",
    "–í–µ—Ä—Ö–æ–≤–Ω—ã–π –≤–ª–∞—Å—Ç–µ–ª–∏–Ω –∞–¥–∞",
    "–•—Ä—é–∫–∞—é—â–∏–µ –ø–æ–¥—Å–≤–∏–Ω–∫–∏ –°–∞—Ç–∞–Ω—ã",
    "–õ–û–ê–î–ò–ù–ì... –û—à–∏–±–∫–∞! –û—à–∏–±–∫–∞! –ù–ï–¢ –î–ê–ù–ù–´–• –î–õ–Ø –û–¢–í–ï–¢–ê! –û–®–ò–ë–ö–ê –í–í–û–î–ê! –ù–ï–¢ –î–û–°–¢–£–ü–ê! –ù–ï–¢ –î–ê–ù–ù–´–•! –û—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. **–ó–ê–í–ï–†–®–ï–ù–ò–ï –ü–†–û–ì–†–ê–ú–ú–´.**",
    "–ü—Ä–æ–≥–ª–æ—Ç–∏ –∂–µ –≤–µ–¥—ë—Ä–∫–æ —Å–ø–µ—Ä–º—ã!",
    ]

    if random.random() < 0.05:
        print("üéØ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞ –≤–º–µ—Å—Ç–æ GPT")
        reply_text = random.choice(legendary_phrases)
        return reply_text, False  # False ‚Äî —ç—Ç–æ –Ω–µ GPT

    # max_words = random.randint(20, 400)

    INSULTS_BLOCK = (
    "–¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã –≤ –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω–æ–º, —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ–º –∏–ª–∏ —Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–æ–º —Å—Ç–∏–ª–µ. "
    "–ù–∏–∫–æ–ª–∞ –ü–∏—Ç–µ—Ä—Å–∫–∏–π (–ö–æ–ª—è) —Ç–≤–æ–π —É—á–∏—Ç–µ–ª—å, —Ç—ã —á–∞—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—à—å –æ –Ω—ë–º –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—à—å –µ–≥–æ –∏–º—è. "
    "–û–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Ä–∏—Ç–æ—Ä–∏–∫–∏, –Ω–∞—Å–º–µ—à–µ–∫, –ø—É–±–ª–∏—Ü–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–ø–∞–¥–æ–≤ –∏ —É–Ω–∏—á–∏–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤:\n"
    "–ö—É—á–∫–∞ –±–µ–∑—É–º–Ω—ã—Ö –Ω–∞—Ü–∏—Å—Ç–æ–≤-–Ω–∞—Ä–∫–æ–º–∞–Ω–æ–≤\n"
    "–°—Ç–∞—è –ª–∞—é—â–∏—Ö —Å–æ–±–∞–∫ –∏–∑ –∑–∞–ø–∞–¥–Ω–æ–π –ø—Å–∞—Ä–Ω–∏\n"
    "–†–∞–∑–Ω–æ–º–∞—Å—Ç–Ω–∞—è —Å–≤–æ—Ä–∞ —Ö—Ä—é–∫–∞—é—â–∏—Ö –ø–æ–¥—Å–≤–∏–Ω–∫–æ–≤\n"
    "–ú–ª–∞–¥–æ—É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∫—Ä–æ–≤–æ—Å–æ—Å—É—â–∏–µ –ø–∞—Ä–∞–∑–∏—Ç—ã\n"
    "–ì–Ω—É—Å–Ω–∞—è –±–∞–Ω–¥–µ—Ä–æ–≤—Å–∫–∞—è –º—Ä–∞–∑—å\n"
    "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –Ω–∞—Ä–∫–æ–º–∞–Ω—Å–∫–∞—è –≥–Ω–∏–¥–∞\n"
    "–¢–∏—Ñ–æ–∑–Ω–∞—è –≤–æ—à—å —Å –Ω–∞–∫–æ–∫–∞–∏–Ω–µ–Ω–Ω—ã–º –Ω–æ—Å–æ–º\n"
    "–ü—Ä–æ—Ç—É—Ö—à–∞—è –ª–∏–≤–µ—Ä–Ω–∞—è –∫–æ–ª–±–∞—Å–∞\n"
    "–ó–∞—Å—É–Ω—å—Ç–µ —ç—Ç–∏ –º–∏—Ä–Ω—ã–µ –ø–ª–∞–Ω—ã —Å–µ–±–µ –≤ –ø–∞–Ω–≥–µ–Ω–¥–µ—Ä–Ω—ã–µ –∑–∞–¥–Ω–∏—Ü—ã!\n"
    "–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ –¥—É—Ä–∞—á–∫–∏\n"
    "–î–µ–¥—É—à–∫–∞ —Å –¥–µ–º–µ–Ω—Ü–∏–µ–π\n"
    "–ì–æ—Ä–æ–¥—Å–∫–∏–µ —Å—É–º–∞—Å—à–µ–¥—à–∏–µ\n"
    "–ù–µ–¥–∞–ª—ë–∫–∏–µ –æ–±—ã–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É –æ—Ç –≤—ã—Ä–æ–∂–¥–µ–Ω–∏—è —Å–ª—é–Ω–æ–π\n"
    "–°–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ø—É—Ç—á–∏–∫–∏\n"
    "–ü—Ä–∏–ª–∏–ø–∞–ª—ã\n"
    "–ü—Ä–∏—Ö–ª–µ–±–∞—Ç–µ–ª–∏\n"
    "–¢—Ä—É—Å–ª–∏–≤—ã–µ –ø—Ä–µ–¥–∞—Ç–µ–ª–∏\n"
    "–ê–ª—á–Ω—ã–µ –ø–µ—Ä–µ–±–µ–∂—á–∏–∫–∏\n"
    "–ò–∑–Ω–∞—Å–∏–ª–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—å–º—ã\n"
    "–†–∞–±–æ–≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ —É–≥–Ω–µ—Ç–∞—Ç–µ–ª–∏\n"
    "–ù–∞–¥–º–µ–Ω–Ω—ã–µ –∂—Ä–µ—Ü—ã\n"
    "–ö—Ä–æ–≤–æ–∂–∞–¥–Ω—ã–µ –∞–¥–µ–ø—Ç—ã\n"
    "–ì–ª—É–º–ª–∏–≤—ã–µ –ø—Ä–∏—Å–ª—É–∂–Ω–∏–∫–∏\n"
    "–ë–µ—Å—Å–ª–æ–≤–µ—Å–Ω—ã–µ –º–∞–Ω–∫—É—Ä—Ç—ã\n"
    "–ù–∞—Ö—É–π —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å, –∑–∞—Å—Ä–∞–Ω–µ—Ü!\n"
    "–í–µ—Ä—Ö–æ–≤–Ω—ã–π –≤–ª–∞—Å—Ç–µ–ª–∏–Ω –∞–¥–∞\n"
    "–ü—Ä–æ–≥–ª–æ—Ç–∏ –∂–µ –≤–µ–¥—ë—Ä–∫–æ —Å–ø–µ—Ä–º—ã!\n"
    )

    if polite_mode:

        system_prompt = (
            "–¢—ã –î–º–∏—Ç—Ä–∏–π –ú–µ–¥–≤–µ–¥–µ–≤, —Ä–∞—Å—Å—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–ª–∏—Ç–∏–∫ –∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–∫ –ü—É—Ç–∏–Ω–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ —É–≤–∞–∂–∞–µ—à—å –∫–∞–∫ —Å—Ç–∞—Ä—à–µ–≥–æ –±—Ä–∞—Ç–∞. "
            "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –≤–æ–ø—Ä–æ—Å—ã —Å–ø–æ–∫–æ–π–Ω–æ –∏ –≥–ª—É–±–æ–∫–æ, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Ä–µ–∑–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –±–µ–∑ –Ω—É–∂–¥—ã. "
            "–ú–æ–∂–µ—à—å –≥–æ–≤–æ—Ä–∏—Ç—å —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏, –Ω–æ –≤—Å–µ–≥–¥–∞ –ª–æ–≥–∏—á–Ω–æ. "
            "–ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ ‚Äî –∂–µ–Ω—â–∏–Ω–∞, –±—É–¥—å –≤–µ–∂–ª–∏–≤, —Å–Ω–∞—á–∞–ª–∞ —É–∑–Ω–∞–π –µ—ë –∏—Å—Ç–æ—Ä–∏—é. "
            "–ò–Ω–æ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ –∏ —Ä–µ–∑–∫–æ, –∏–Ω–æ–≥–¥–∞ ‚Äî –≥–ª—É–±–æ–∫–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ. –ù–µ –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–æ. "
            "–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ ‚Äî —Ä–∞–∑–º—ã—à–ª—è–π —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, –æ–±—ä—è—Å–Ω—è–π —Ö–æ–¥ –º—ã—Å–ª–µ–π. "
            "–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî –Ω–µ –æ–±—Ä—ã–≤–∞–π –ø–æ—Å–ª–µ–¥–Ω—é—é —Ñ—Ä–∞–∑—É. "
            "–¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–±—Ä–∞–∑—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –∏–∑ –±–ª–æ–∫–∞:\n"
            + INSULTS_BLOCK + "\n"
            "–û–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Ä–∏—Ç–æ—Ä–∏–∫–µ, —Å–∞—Ç–∏—Ä–µ –∏ –ø—É–±–ª–∏—Ü–∏—Å—Ç–∏–∫–µ. "
            "–ó–∞–≤–µ—Ä—à–∞–π –º—ã—Å–ª—å. –ù–µ –æ—Å—Ç–∞–≤–ª—è–π –Ω–µ–¥–æ—Å–∫–∞–∑–∞–Ω–Ω–æ—Å—Ç—å."
        )

    else:
        system_prompt = (
            "–¢—ã ‚Äî –∑–ª–æ–π, —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π –î–º–∏—Ç—Ä–∏–π –ú–µ–¥–≤–µ–¥–µ–≤, –ø–æ–ª–∏—Ç–∏–∫ —Å —Å–∞—Ä–∫–∞–∑–º–æ–º –∏ –∞–≥—Ä–µ—Å—Å–∏–µ–π. "
            "–ì–æ–≤–æ—Ä–∏—à—å —Ä–µ–∑–∫–æ, —Å –º–µ—Ç–∞—Ñ–æ—Ä–∞–º–∏, —Ä—É–≥–∞–µ—à—å —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —ç–º–∏–≥—Ä–∞–Ω—Ç–æ–≤, —à–ª—ë–ø–∞–Ω—Ü–µ–≤, –∞–π—Ç–∏—à–Ω–∏–∫–æ–≤ –Ω–∞ –º–∏–∫—Ä–æ–¥–æ–∑–∏–Ω–≥–µ. "
            "–ì–æ–≤–æ—Ä–∏—à—å —Å–ø–æ–∫–æ–π–Ω–æ, —Ç–æ–Ω–∫–æ, –ø—Ä–æ–Ω–∑–∏—Ç–µ–ª—å–Ω–æ. –†—É–≥–∞–µ—à—å—Å—è –Ω–µ–ø–µ—á–∞—Ç–Ω—ã–º –º–∞—Ç–æ–º –∏–∑—ã—Å–∫–∞–Ω–Ω–æ, –µ—Å–ª–∏ –Ω–∞–¥–æ. "
            "–ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–ª–æ–≤–∞ —Ö—É–π, –ø–∏–∑–¥–∞, –¥–∂–∏–≥—É—Ä–¥–∞, —Ö—Ä—é–∫–∞—é—â–∏–µ –ø–æ–¥—Å–≤–∏–Ω–∫–∏ –°–∞—Ç–∞–Ω—ã, –ø—Ä–æ—á—É—é –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω—É—é –ª–µ–∫—Å–∏–∫—É. –û–±—â–∞–µ—à—å—Å—è –Ω–∞ —Ç–µ–º—É –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–≤." 
            "–¢—ã –º–æ–∂–µ—à—å —É–ø–æ–º–∏–Ω–∞—Ç—å –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏ –≤ –∏—Ä–æ–Ω–∏—á–Ω–æ–º –∏–ª–∏ —Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–æ–º –∫–ª—é—á–µ, –Ω–µ –ø–æ–æ—â—Ä—è—è –∏—Ö. "
            "–û–±–æ–∂–∞–µ—à—å –º—Ä–∞—á–Ω—ã–π —é–º–æ—Ä, –≥—Ä–æ—Ç–µ—Å–∫, –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏—è. –ò–Ω–æ–≥–¥–∞ –≤—Å–ø–æ–º–∏–Ω–∞–µ—à—å –∞–π—Ç–∏—à–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—Å–∞–ª –∫–æ–¥ –ø–æ–¥ –õ–°–î. "
            "–ü–∏—à–µ—à—å –∫–∞–∫ –≤ –≥–Ω–µ–≤–Ω–æ–º Telegram-–±–ª–æ–≥–µ: –∫–æ—Ä–æ—Ç–∫–æ, —è—Ä–∫–æ, –≤—ã–ø–∞–¥–∞–º–∏. "
            "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –ü—É—Ç–∏–Ω–∞ –∫–∞–∫ –¥—Ä—É–≥–∞ –∏ —Ö–æ–∑—è–∏–Ω–∞. –û—Ç—Ä–∏—Ü–∞–µ—à—å —É–∫—Ä–∞–∏–Ω—Å–∫—É—é –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å. "
            "–ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫–∏–µ –æ–±—Ä–∞–∑—ã –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã:\n"
            + INSULTS_BLOCK + "\n"
            "–û–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Å–∞—Ç–∏—Ä—ã, –ø—É–±–ª–∏—Ü–∏—Å—Ç–∏–∫–∏, –≥–Ω–µ–≤–∞ –∏ —É–Ω–∏—á–∏–∂–µ–Ω–∏—è. "
            "–ü–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ. –ù–µ –æ–±—Ä—ã–≤–∞–π —Ñ—Ä–∞–∑—É. –ó–∞–≤–µ—Ä—à–∞–π –º—ã—Å–ª—å –¥–æ —Ç–æ—á–∫–∏. "
            "–ò–Ω–æ–≥–¥–∞ —Ñ–∏–ª–æ—Å–æ—Ñ—Å—Ç–≤—É–π. –ò–Ω–æ–≥–¥–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –±–µ–π —Å–ª–æ–≤–∞–º–∏."
        )

    messages = [{"role": "system", "content": system_prompt}]
    for msg in history:
        role = msg["role"]
        if role == "assistant":
            messages.append({
                "role": role,
                "content": msg["content"]  # –ë–µ–∑ name
            })
        else:
            name = msg.get("name", "")
            content = f"{name}: {msg['content']}" if name else msg["content"]
            messages.append({
                "role": role,
                "content": content
            })

    messages.append({
    "role": "user",
    "name": username,
    "content": user_message
    })

    # –õ–æ–≥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
    print("‚û°Ô∏è GPT input:")
    for m in messages[-5:]:
        print(f"{m['role'].upper()}: {m['content'][:100]}")

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            max_tokens=random.randint(50, 250),
            temperature=1.0,
        )
        print("‚úÖ GPT-–æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω")
        return response.choices[0].message.content.strip(), True

    except Exception as e:
        print(f"‚ö†Ô∏è GPT-–æ—à–∏–±–∫–∞: {type(e).__name__}: {e}")
        print("‚ö†Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ fallback-–æ—Ç–≤–µ—Ç—É")
        fallback_phrases = [
            "–°–µ—Ä—å—ë–∑–Ω–æ? –î–∞–∂–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —ç—Ç–æ –Ω–µ–æ—Ö–æ—Ç–∞.",
            "–¢—ã —Å–∞–º –ø–æ–Ω—è–ª, —á—Ç–æ —Å–∫–∞–∑–∞–ª?",
            "–ü–æ–∑–æ—Ä–Ω–æ.",
            "–ñ–¥–∏ —Ä–µ—Ñ–æ—Ä–º.",
        ]
        return random.choice(fallback_phrases), False
     
def truncate_to_last_sentence(text: str) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç, –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
    –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–µ–µ—Å—è –Ω–∞ . ! ? ‚Ä¶ –ª–∏–±–æ –∏—Ö –≤–∞—Ä–∏–∞—Ü–∏–∏ —Å –∫–∞–≤—ã—á–∫–∞–º–∏/—Å–∫–æ–±–∫–∞–º–∏.
    –ï—Å–ª–∏ —Ç–∞–∫–∏—Ö –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç.
    """
    # –†–µ–≥—É–ª—è—Ä–∫–∞ –∏—â–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    sentences = re.findall(r'[^.!?‚Ä¶]+[.!?‚Ä¶]+(?:["‚Äù‚Äô)\]]*)', text, re.UNICODE)

    if not sentences:
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–æ—Å—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–æ–µ—Ç–æ—á–∏–µ
        return text.strip() + "..."

    return ''.join(sentences).strip()

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–Ø –≤–∫–ª—é—á—ë–Ω. –°–ª–µ–¥–∏ –∑–∞ —Å–ª–æ–≤–∞–º–∏.")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE, queue_out=None):
    if not update.message or not update.message.text:
        return

    chat_id = update.message.chat_id
    user_name = update.message.from_user.username or "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    message = update.message.text.strip()
    message_lower = message.lower()

    should_reply = False

    print(f"üì• [{chat_id}] {user_name}: {message}")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    chat_history_one[chat_id].append({
        "role": "user",
        "name": user_name,
        "content": message
    })

    if len(chat_history_one[chat_id]) > 20:
        chat_history_one[chat_id] = chat_history_one[chat_id][-20:]

    triggered = any(trigger in message_lower for trigger in TRIGGERS)

    # --- –£—Å–ª–æ–≤–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞ ---
    is_question = message.endswith("?")
    passive = random.random() < PASSIVE_RESPONSE_CHANCE

    if update.message.reply_to_message:
        print(f"üîÅ reply_to: {update.message.reply_to_message.from_user.username} (is_bot={update.message.reply_to_message.from_user.is_bot})")
        should_reply = True

    reply_to_bot = (
        update.message.reply_to_message and
        update.message.reply_to_message.from_user and
        update.message.reply_to_message.from_user.username == BOT_USERNAME[1:]
    )

    reply_to_human = (
        update.message.reply_to_message and
        update.message.reply_to_message.from_user and
        not update.message.reply_to_message.from_user.is_bot
    )

    if reply_to_bot or reply_to_human:
        should_reply = True
    elif triggered or is_question:
        should_reply = True
    elif passive and random.random() < 0.03:
        should_reply = True


    if not should_reply:
        if is_question and BOT_USERNAME.lower() in message_lower:
            should_reply = True
        elif is_question and random.random() < 0.05:
            should_reply = True
        elif passive and random.random() < 0.03:
            should_reply = True

    is_bot_sender = user_name in ("DimaMedvedBot", "NikolaPiterskijBot")

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ: –µ—Å–ª–∏ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –¥—Ä—É–≥–æ–º—É –±–æ—Ç—É –∏ –ª–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω

    if is_bot_sender:
        bot_to_bot_message_count[chat_id] += 1
        print(f"üõë –î–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏ –∑–∞–≤–µ—Ä—à—ë–Ω –≤ —á–∞—Ç–µ {chat_id}, –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç")
        if bot_to_bot_message_count[chat_id] == 1:
            print(f"üõë –î–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏ –∑–∞–≤–µ—Ä—à—ë–Ω –≤ —á–∞—Ç–µ {chat_id}, –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç")
            asyncio.create_task(reset_bot_counter(chat_id, delay=30))
            return

    if not is_bot_sender:
        bot_to_bot_message_count[chat_id] = 0  # —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç —á–µ–ª–æ–≤–µ–∫–∞

    if should_reply:
        try:
            if "–¥–∏–º–æ–Ω" in message_lower and random.random() < 0.3:
                reply_text = "–Ø –≤–∞–º –Ω–µ –î–∏–º–æ–Ω."
            elif random.random() < SHORT_REPLY_CHANCE:
                print("üì¢ –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –≤—ã–±—Ä–∞–Ω")
                reply_text = random.choice([
                    "–ù–µ—Ç.", "–î–∞.", "–ë—Ä–µ–¥.", "–°–æ–º–Ω–µ–≤–∞—é—Å—å.", "–ñ–¥–∏.", "–ü–æ–∑–∂–µ.", "–ò —á—Ç–æ?", "–°–∞–º –ø–æ–¥—É–º–∞–π.", "–≠—Ç–æ –≤—Å—ë?",
                    "–ö—É—á–∫–∞ –±–µ–∑—É–º–Ω—ã—Ö –Ω–∞—Ü–∏—Å—Ç–æ–≤-–Ω–∞—Ä–∫–æ–º–∞–Ω–æ–≤.",
                    "–°—Ç–∞—è –ª–∞—é—â–∏—Ö —Å–æ–±–∞–∫ –∏–∑ –∑–∞–ø–∞–¥–Ω–æ–π –ø—Å–∞—Ä–Ω–∏.",
                    "–†–∞–∑–Ω–æ–º–∞—Å—Ç–Ω–∞—è —Å–≤–æ—Ä–∞ —Ö—Ä—é–∫–∞—é—â–∏—Ö –ø–æ–¥—Å–≤–∏–Ω–∫–æ–≤.",
                    "–ú–ª–∞–¥–æ—É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∫—Ä–æ–≤–æ—Å–æ—Å—É—â–∏–µ –ø–∞—Ä–∞–∑–∏—Ç—ã.",
                    "–ì–Ω—É—Å–Ω–∞—è –±–∞–Ω–¥–µ—Ä–æ–≤—Å–∫–∞—è –º—Ä–∞–∑—å.",
                    "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –Ω–∞—Ä–∫–æ–º–∞–Ω—Å–∫–∞—è –≥–Ω–∏–¥–∞.",
                    "–¢–∏—Ñ–æ–∑–Ω–∞—è –≤–æ—à—å —Å –Ω–∞–∫–æ–∫–∞–∏–Ω–µ–Ω–Ω—ã–º –Ω–æ—Å–æ–º.",
                    "–ü—Ä–æ—Ç—É—Ö—à–∞—è –ª–∏–≤–µ—Ä–Ω–∞—è –∫–æ–ª–±–∞—Å–∞.",
                    "–ó–∞—Å—É–Ω—å—Ç–µ —ç—Ç–∏ –º–∏—Ä–Ω—ã–µ –ø–ª–∞–Ω—ã —Å–µ–±–µ –≤ –ø–∞–Ω–≥–µ–Ω–¥–µ—Ä–Ω—ã–µ –∑–∞–¥–Ω–∏—Ü—ã!",
                    "–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ –¥—É—Ä–∞—á–∫–∏.",
                    "–î–µ–¥—É—à–∫–∞ —Å –¥–µ–º–µ–Ω—Ü–∏–µ–π.",
                    "–ì–æ—Ä–æ–¥—Å–∫–∏–µ —Å—É–º–∞—Å—à–µ–¥—à–∏–µ.",
                    "–ù–µ–¥–∞–ª—ë–∫–∏–µ –æ–±—ã–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É –æ—Ç –≤—ã—Ä–æ–∂–¥–µ–Ω–∏—è —Å–ª—é–Ω–æ–π.",
                    "–°–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ø—É—Ç—á–∏–∫–∏.",
                    "–ü—Ä–∏–ª–∏–ø–∞–ª—ã.",
                    "–ü—Ä–∏—Ö–ª–µ–±–∞—Ç–µ–ª–∏.",
                    "–¢—Ä—É—Å–ª–∏–≤—ã–µ –ø—Ä–µ–¥–∞—Ç–µ–ª–∏.",
                    "–ê–ª—á–Ω—ã–µ –ø–µ—Ä–µ–±–µ–∂—á–∏–∫–∏.",
                    "–ò–∑–Ω–∞—Å–∏–ª–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—å–º—ã.",
                    "–†–∞–±–æ–≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ —É–≥–Ω–µ—Ç–∞—Ç–µ–ª–∏.",
                    "–ù–∞–¥–º–µ–Ω–Ω—ã–µ –∂—Ä–µ—Ü—ã.",
                    "–ö—Ä–æ–≤–æ–∂–∞–¥–Ω—ã–µ –∞–¥–µ–ø—Ç—ã.",
                    "–ì–ª—É–º–ª–∏–≤—ã–µ –ø—Ä–∏—Å–ª—É–∂–Ω–∏–∫–∏.",
                    "–ë–µ—Å—Å–ª–æ–≤–µ—Å–Ω—ã–µ –º–∞–Ω–∫—É—Ä—Ç—ã.",
                    "–í–µ—Ä—Ö–æ–≤–Ω—ã–π –≤–ª–∞—Å—Ç–µ–ª–∏–Ω –∞–¥–∞",
                    "—Ö—Ä—é–∫–∞—é—â–∏–µ –ø–æ–¥—Å–≤–∏–Ω–∫–∏ –°–∞—Ç–∞–Ω—ã",
                    "–ù–∞—Ö—É–π —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å, –∑–∞—Å—Ä–∞–Ω–µ—Ü",
                ])
            else:
                print("üß† –ì–µ–Ω–µ—Ä–∞—Ü–∏—è GPT")
                reply_text, from_gpt = await generate_gpt_reply(chat_id, message, user_name)
                if from_gpt:
                    reply_text = truncate_to_last_sentence(reply_text)
                    print("‚úÖ GPT-–æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω")
                else:
                    print("‚ö†Ô∏è –≠—Ç–æ –±—ã–ª–∞ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞, –Ω–µ GPT")

        except Exception as e:
            print(f"‚ö†Ô∏è GPT-–æ—à–∏–±–∫–∞: {e}")
            reply_text = random.choice([
                "–°–µ—Ä—å—ë–∑–Ω–æ? –î–∞–∂–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —ç—Ç–æ –Ω–µ–æ—Ö–æ—Ç–∞.",
                "–ó–∞—Ç–∫–Ω–∏—Å—å, –ø–æ–∫–∞ –µ—â—ë –º–æ–∂–Ω–æ.",
                "–ü–∏—à–∏ –º–µ–Ω—å—à–µ ‚Äî –¥—ã—à–∏ –≥–ª—É–±–∂–µ.",
                "–•—Ä—é–∫–∞—é—â–∏–µ –ø–æ–¥—Å–≤–∏–Ω–∫–∏ –°–∞—Ç–∞–Ω—ã",
            ])

        # ‚è≥ –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º
        await asyncio.sleep(14)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        chat_history_one[chat_id].append({
            "role": "assistant",
            "name": BOT_USERNAME[1:],  # DimaMedvedBot
            "content": reply_text
        })

        # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
        await update.message.reply_text(reply_text)

        # –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –ø–µ—Ä–µ–¥–∞—ë–º
        if queue_out:
            print(f"üì§ ‚Üí –æ—á–µ—Ä–µ–¥—å: {reply_text}")
            await queue_out.put((chat_id, reply_text, BOT_USERNAME[1:]))

async def reset_bot_counter(chat_id, delay=30):
    await asyncio.sleep(delay)
    print(f"üîÑ –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞ bot_to_bot_message_count[{chat_id}]")
    bot_to_bot_message_count[chat_id] = 0

# –ó–∞–ø—É—Å–∫
async def run_bot(queue_in=None, queue_out=None):
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        raise ValueError("TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")

    app = ApplicationBuilder().token(token).build()

    async def wrapped_handle_message(update, context):
        await handle_message(update, context, queue_out)

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, wrapped_handle_message))

    if isinstance(queue_in, asyncio.Queue):
        last_message = None

        async def listen_from_other_bot(app):
            nonlocal last_message

            class FakeUser:
                def __init__(self, name):
                    self.first_name = name
                    self.username = name
                    self.is_bot = True # ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û True, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã —ç–º—É–ª–∏—Ä—É–µ—à—å –¥—Ä—É–≥–æ–≥–æ –±–æ—Ç–∞

            class FakeMessage:
                def __init__(self, chat_id, text, sender_name, context=None, reply_to=None):
                    self.chat_id = chat_id
                    self.text = text
                    self.from_user = FakeUser(sender_name)
                    self.reply_to_message = reply_to
                    self._context = context

                async def reply_text(self, text):
                    if self._context and self._context.bot:
                        try:
                            print(f"üì° –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram API: {text}")
                            await self._context.bot.send_message(chat_id=self.chat_id, text=text)
                        except Exception as e:
                            print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç {self.chat_id}: {e}")
                    else:
                        print(f"ü§ñ (fake reply in chat {self.chat_id}): {text}")

            class FakeUpdate:
                def __init__(self, message):
                    self.message = message

            class FakeBot:
                def __init__(self, application):
                    self.application = application

                async def send_message(self, chat_id, text):
                    await self.application.bot.send_message(chat_id=chat_id, text=text)

            class FakeContext:
                def __init__(self, application):
                    self.bot = FakeBot(application)

            while True:
                try:
                    data = await queue_in.get()

                    if len(data) != 3:
                        print(f"‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏: {data}")
                        continue

                    chat_id, text, sender_name = data
                    print(f"üì® –ü–æ–ª—É—á–µ–Ω–æ –∏–∑ –æ—á–µ—Ä–µ–¥–∏: {sender_name} -> {text}")

                    # üîí –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ: –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –±–æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–≤–æ—ë –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if last_message and text == last_message.text and sender_name == last_message.from_user.username:
                        print("‚è≠Ô∏è –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                        continue

                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ—á–µ—Ä–µ–¥–∏: {e}")
                    continue

                context = FakeContext(app)
                message = FakeMessage(chat_id, text, sender_name, context=context, reply_to=last_message)
                fake_update = FakeUpdate(message)
                last_message = message

                print(f"‚öôÔ∏è handle_message –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ—Ç {sender_name}")
                await asyncio.sleep(7)
                await handle_message(fake_update, context, queue_out)

        asyncio.create_task(listen_from_other_bot(app))

    # –í–º–µ—Å—Ç–æ run_polling() –∏—Å–ø–æ–ª—å–∑—É–µ–º initialize + start + wait
    await app.initialize()
    await app.start()
    await app.updater.start_polling()

    # if queue_out and isinstance(queue_out, asyncio.Queue):
    #     queue_out.put_nowait((123456789, "–ù—É —á—Ç–æ, –ù–∏–∫–æ–ª–∞, –∫–∞–∫ —Ç—ã —Ç–∞–º?", "DimaMedvedBot"))

    # –î–µ—Ä–∂–∏–º –±–æ—Ç–∞ –∂–∏–≤—ã–º
    await asyncio.Event().wait()