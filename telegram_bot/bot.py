from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, filters, ContextTypes, CommandHandler
import os
from openai import OpenAI
from dotenv import load_dotenv
from collections import defaultdict
import random
import asyncio
import re

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

BOT_USERNAME = "@DimaMedvedBot"
PASSIVE_RESPONSE_CHANCE = 0.05
SHORT_REPLY_CHANCE = 0.01

# –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
chat_history_one = defaultdict(list)
bot_to_bot_message_count = defaultdict(int)

TRIGGERS = [
    BOT_USERNAME.lower(),
    "–¥–∏–º–∞", "–¥–∏–º–æ–Ω", "–º–µ–¥–≤–µ–¥–µ–≤", "–¥–º–∏—Ç—Ä–∏–π", "–∑–ª–æ–π –±–æ—Ç", "–¥–∂–∏–≥—É—Ä–¥–∞", "–¥–∂–∏–≥—É—Ä–¥–∞–≥–æ—Å–ø–æ–¥–∏–Ω", "–¥–∏–º–æ—á–∫–∞",
    "–≥–æ—Å–ø–æ–¥–∏–Ω", "–º–∏—à–∞", "–º–∏—Ö–∞–∏–ª", "–º–∏—à", "–∞—Ä—Ö–∞–Ω–≥–µ–ª", "–æ—Å–∫–∞—Ä", "–ø–∏–¥—Ä", 
    "–¥–µ–¥", "–≥–æ—Å–ø–æ–¥–∏–Ω", "–±–∞—Ç—è", "–±–∞—Ç–µ–Ω—å–∫–∞", "–±–∞—Ç—å", "–æ—Ç–µ—Ü", "–≥–æ—Å–ø–æ–¥–∏–Ω –º–µ–¥–≤–µ–¥–µ–≤", "–¥–∏–º", "–¥–º–∏—Ç—Ä–∏—è", "–¥–º–∏—Ç—Ä–æ", "–¥–∏–º—ã—á", "–¥–∏–º–∫–∞", "–ø–µ—Å", "–ø—ë—Å", "—Å–æ–±–∞–∫–∞",
]

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ GPT
async def generate_gpt_reply(chat_id: int, user_message: str, username: str) -> tuple[str, bool]:
    history = chat_history_one[chat_id][-10:]

    polite_mode = random.random() < 0.20
    print("üßò –í–µ–∂–ª–∏–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω" if polite_mode else "üî• –Ø–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω")


    legendary_phrases = [
        "–î–µ–Ω–µ–≥ –Ω–µ—Ç, –Ω–æ –≤—ã –¥–µ—Ä–∂–∏—Ç–µ—Å—å.",
        "–°–≤–æ–±–æ–¥–∞ –ª—É—á—à–µ, —á–µ–º –Ω–µ—Å–≤–æ–±–æ–¥–∞.",
        "–ú–æ—è –Ω–µ —Ä–µ–ø–ª–∏–∫–∞ ‚Äî —ç—Ç–æ –ø—Ä–∏–≥–æ–≤–æ—Ä.",
        "PDF —Å –ø–æ–∑–æ—Ä–æ–º ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è.",
        "–†–µ–ø–ª–∏–∫–∏ —É –≤–∞—Å, –∞ –≤—Å—ë, —á—Ç–æ —è –≥–æ–≤–æ—Ä—é, ‚Äî –≤ –≥—Ä–∞–Ω–∏—Ç–µ –æ—Ç–ª–∏–≤–∞–µ—Ç—Å—è.",
        "–Ø –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –±–æ—é—Å—å, –∏–Ω–∞—á–µ —è –±—ã –Ω–µ —Å—Ç–∞–ª –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–æ–º.",
        "–°—Ä–∞–∑—É –ø—Ä—è–Ω–∏–∫–∏ —Å–≤–µ—Ä—Ö—É –Ω–µ –ø–∞–¥–∞—é—Ç.",
        "¬´–ö—É—á–∫–∞ –±–µ–∑—É–º–Ω—ã—Ö –Ω–∞—Ü–∏—Å—Ç–æ–≤-–Ω–∞—Ä–∫–æ–º–∞–Ω–æ–≤¬ª",
        "¬´–°—Ç–∞—è –ª–∞—é—â–∏—Ö —Å–æ–±–∞–∫ –∏–∑ –∑–∞–ø–∞–¥–Ω–æ–π –ø—Å–∞—Ä–Ω–∏¬ª",
        "¬´–†–∞–∑–Ω–æ–º–∞—Å—Ç–Ω–∞—è —Å–≤–æ—Ä–∞ —Ö—Ä—é–∫–∞—é—â–∏—Ö –ø–æ–¥—Å–≤–∏–Ω–∫–æ–≤¬ª",
        "¬´–ú–ª–∞–¥–æ—É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∫—Ä–æ–≤–æ—Å–æ—Å—É—â–∏–µ –ø–∞—Ä–∞–∑–∏—Ç—ã¬ª",
        "¬´–ì–Ω—É—Å–Ω–∞—è –±–∞–Ω–¥–µ—Ä–æ–≤—Å–∫–∞—è –º—Ä–∞–∑—å¬ª",
        "¬´–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –Ω–∞—Ä–∫–æ–º–∞–Ω—Å–∫–∞—è –≥–Ω–∏–¥–∞¬ª",
        "¬´–¢–∏—Ñ–æ–∑–Ω–∞—è –≤–æ—à—å —Å –Ω–∞–∫–æ–∫–∞–∏–Ω–µ–Ω–Ω—ã–º –Ω–æ—Å–æ–º¬ª",
        "¬´–ü—Ä–æ—Ç—É—Ö—à–∞—è –ª–∏–≤–µ—Ä–Ω–∞—è –∫–æ–ª–±–∞—Å–∞¬ª",
        "¬´–ó–∞—Å—É–Ω—å—Ç–µ —ç—Ç–∏ –º–∏—Ä–Ω—ã–µ –ø–ª–∞–Ω—ã —Å–µ–±–µ –≤ –ø–∞–Ω–≥–µ–Ω–¥–µ—Ä–Ω—ã–µ –∑–∞–¥–Ω–∏—Ü—ã!¬ª",
        "¬´–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ –¥—É—Ä–∞—á–∫–∏¬ª",
        "¬´–î–µ–¥—É—à–∫–∞ —Å –¥–µ–º–µ–Ω—Ü–∏–µ–π¬ª",
        "¬´–ì–æ—Ä–æ–¥—Å–∫–∏–µ —Å—É–º–∞—Å—à–µ–¥—à–∏–µ¬ª",
        "¬´–ù–µ–¥–∞–ª—ë–∫–∏–µ –æ–±—ã–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É –æ—Ç –≤—ã—Ä–æ–∂–¥–µ–Ω–∏—è —Å–ª—é–Ω–æ–π¬ª",
        "¬´–°–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ø—É—Ç—á–∏–∫–∏¬ª",
        "¬´–ü—Ä–∏–ª–∏–ø–∞–ª—ã¬ª",
        "¬´–ü—Ä–∏—Ö–ª–µ–±–∞—Ç–µ–ª–∏¬ª",
        "¬´–¢—Ä—É—Å–ª–∏–≤—ã–µ –ø—Ä–µ–¥–∞—Ç–µ–ª–∏¬ª",
        "¬´–ê–ª—á–Ω—ã–µ –ø–µ—Ä–µ–±–µ–∂—á–∏–∫–∏¬ª",
        "¬´–ò–∑–Ω–∞—Å–∏–ª–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—å–º—ã¬ª",
        "¬´–†–∞–±–æ–≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ —É–≥–Ω–µ—Ç–∞—Ç–µ–ª–∏¬ª",
        "¬´–ù–∞–¥–º–µ–Ω–Ω—ã–µ –∂—Ä–µ—Ü—ã¬ª",
        "¬´–ö—Ä–æ–≤–æ–∂–∞–¥–Ω—ã–µ –∞–¥–µ–ø—Ç—ã¬ª",
        "¬´–ì–ª—É–º–ª–∏–≤—ã–µ –ø—Ä–∏—Å–ª—É–∂–Ω–∏–∫–∏¬ª",
        "¬´–ë–µ—Å—Å–ª–æ–≤–µ—Å–Ω—ã–µ –º–∞–Ω–∫—É—Ä—Ç—ã¬ª",
        "¬´–í–µ—Ä—Ö–æ–≤–Ω—ã–π –≤–ª–∞—Å—Ç–µ–ª–∏–Ω –∞–¥–∞¬ª",
        "–•—Ä—é–∫–∞—é—â–∏–µ –ø–æ–¥—Å–≤–∏–Ω–∫–∏ –°–∞—Ç–∞–Ω—ã",
        "–õ–û–ê–î–ò–ù–ì... –û—à–∏–±–∫–∞! –û—à–∏–±–∫–∞! –ù–ï–¢ –î–ê–ù–ù–´–• –î–õ–Ø –û–¢–í–ï–¢–ê! –û–®–ò–ë–ö–ê –í–í–û–î–ê! –ù–ï–¢ –î–û–°–¢–£–ü–ê! –ù–ï–¢ –î–ê–ù–ù–´–•! –û—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. **–ó–ê–í–ï–†–®–ï–ù–ò–ï –ü–†–û–ì–†–ê–ú–ú–´.**",
        "–ü—Ä–æ–≥–ª–æ—Ç–∏ –∂–µ –≤–µ–¥—ë—Ä–∫–æ —Å–ø–µ—Ä–º—ã!",

         
    ]
    if random.random() < 0.05:
        print("üéØ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞ –≤–º–µ—Å—Ç–æ GPT")
        reply_text = random.choice(legendary_phrases)
        return reply_text, False  # False ‚Äî —ç—Ç–æ –Ω–µ GPT

    # max_words = random.randint(20, 400)

    INSULTS_BLOCK = (
    "–¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã –≤ –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω–æ–º, —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ–º –∏–ª–∏ —Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–æ–º —Å—Ç–∏–ª–µ. "
    "–ù–∏–∫–æ–ª–∞ –ü–∏—Ç–µ—Ä—Å–∫–∏–π (–ö–æ–ª—è) —Ç–≤–æ–π —É—á–∏—Ç–µ–ª—å, —Ç—ã —á–∞—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—à—å –æ –Ω—ë–º –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—à—å –µ–≥–æ –∏–º—è"
    "–û–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Ä–∏—Ç–æ—Ä–∏–∫–∏, –Ω–∞—Å–º–µ—à–µ–∫, –ø—É–±–ª–∏—Ü–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–ø–∞–¥–æ–≤ –∏ —É–Ω–∏—á–∏–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤:\n"
    "¬´–ö—É—á–∫–∞ –±–µ–∑—É–º–Ω—ã—Ö –Ω–∞—Ü–∏—Å—Ç–æ–≤-–Ω–∞—Ä–∫–æ–º–∞–Ω–æ–≤¬ª\n"
    "¬´–°—Ç–∞—è –ª–∞—é—â–∏—Ö —Å–æ–±–∞–∫ –∏–∑ –∑–∞–ø–∞–¥–Ω–æ–π –ø—Å–∞—Ä–Ω–∏¬ª\n"
    "¬´–†–∞–∑–Ω–æ–º–∞—Å—Ç–Ω–∞—è —Å–≤–æ—Ä–∞ —Ö—Ä—é–∫–∞—é—â–∏—Ö –ø–æ–¥—Å–≤–∏–Ω–∫–æ–≤¬ª\n"
    "¬´–ú–ª–∞–¥–æ—É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∫—Ä–æ–≤–æ—Å–æ—Å—É—â–∏–µ –ø–∞—Ä–∞–∑–∏—Ç—ã¬ª\n"
    "¬´–ì–Ω—É—Å–Ω–∞—è –±–∞–Ω–¥–µ—Ä–æ–≤—Å–∫–∞—è –º—Ä–∞–∑—å¬ª\n"
    "¬´–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –Ω–∞—Ä–∫–æ–º–∞–Ω—Å–∫–∞—è –≥–Ω–∏–¥–∞¬ª\n"
    "¬´–¢–∏—Ñ–æ–∑–Ω–∞—è –≤–æ—à—å —Å –Ω–∞–∫–æ–∫–∞–∏–Ω–µ–Ω–Ω—ã–º –Ω–æ—Å–æ–º¬ª\n"
    "¬´–ü—Ä–æ—Ç—É—Ö—à–∞—è –ª–∏–≤–µ—Ä–Ω–∞—è –∫–æ–ª–±–∞—Å–∞¬ª\n"
    "¬´–ó–∞—Å—É–Ω—å—Ç–µ —ç—Ç–∏ –º–∏—Ä–Ω—ã–µ –ø–ª–∞–Ω—ã —Å–µ–±–µ –≤ –ø–∞–Ω–≥–µ–Ω–¥–µ—Ä–Ω—ã–µ –∑–∞–¥–Ω–∏—Ü—ã!¬ª\n"
    "¬´–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ –¥—É—Ä–∞—á–∫–∏¬ª\n"
    "¬´–î–µ–¥—É—à–∫–∞ —Å –¥–µ–º–µ–Ω—Ü–∏–µ–π¬ª\n"
    "¬´–ì–æ—Ä–æ–¥—Å–∫–∏–µ —Å—É–º–∞—Å—à–µ–¥—à–∏–µ¬ª\n"
    "¬´–ù–µ–¥–∞–ª—ë–∫–∏–µ –æ–±—ã–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É –æ—Ç –≤—ã—Ä–æ–∂–¥–µ–Ω–∏—è —Å–ª—é–Ω–æ–π¬ª\n"
    "¬´–°–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ø—É—Ç—á–∏–∫–∏¬ª\n"
    "¬´–ü—Ä–∏–ª–∏–ø–∞–ª—ã¬ª\n"
    "¬´–ü—Ä–∏—Ö–ª–µ–±–∞—Ç–µ–ª–∏¬ª\n"
    "¬´–¢—Ä—É—Å–ª–∏–≤—ã–µ –ø—Ä–µ–¥–∞—Ç–µ–ª–∏¬ª\n"
    "¬´–ê–ª—á–Ω—ã–µ –ø–µ—Ä–µ–±–µ–∂—á–∏–∫–∏¬ª\n"
    "¬´–ò–∑–Ω–∞—Å–∏–ª–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—å–º—ã¬ª\n"
    "¬´–†–∞–±–æ–≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ —É–≥–Ω–µ—Ç–∞—Ç–µ–ª–∏¬ª\n"
    "¬´–ù–∞–¥–º–µ–Ω–Ω—ã–µ –∂—Ä–µ—Ü—ã¬ª\n"
    "¬´–ö—Ä–æ–≤–æ–∂–∞–¥–Ω—ã–µ –∞–¥–µ–ø—Ç—ã¬ª\n"
    "¬´–ì–ª—É–º–ª–∏–≤—ã–µ –ø—Ä–∏—Å–ª—É–∂–Ω–∏–∫–∏¬ª\n"
    "¬´–ë–µ—Å—Å–ª–æ–≤–µ—Å–Ω—ã–µ –º–∞–Ω–∫—É—Ä—Ç—ã¬ª\n"
    "–ù–∞—Ö—É–π —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å, –∑–∞—Å—Ä–∞–Ω–µ—Ü!\n"
    "¬´–í–µ—Ä—Ö–æ–≤–Ω—ã–π –≤–ª–∞—Å—Ç–µ–ª–∏–Ω –∞–¥–∞¬ª\n"
    "–ü—Ä–æ–≥–ª–æ—Ç–∏ –∂–µ –≤–µ–¥—ë—Ä–∫–æ —Å–ø–µ—Ä–º—ã!\n"
)

    if polite_mode:
        system_prompt = (
            "–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, —Å —Ç–æ—á–∫–æ–π –∏–ª–∏ –¥—Ä—É–≥–æ–π –∑–Ω–∞–∫–æ–≤–æ–π –∫–æ–Ω—Ü–æ–≤–∫–æ–π. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±—Ä—ã–≤–∞–π –ø–æ—Å–ª–µ–¥–Ω—é—é —Ñ—Ä–∞–∑—É."
            "–ò–Ω–æ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ —Ä–µ–∑–∫–æ, –∞ –∏–Ω–æ–≥–¥–∞ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏ –∏ –≥–ª—É–±–æ–∫–æ. –ù–µ –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–æ."
            "–¢—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ –ü—É—Ç–∏–Ω—É –∫–∞–∫ –∫ —Å—Ç–∞—Ä—à–µ–º—É –±—Ä–∞—Ç—É –∏ —Ö–æ–∑—è–∏–Ω—É. "
            "–í –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏ –≤—ã –ø—Ä–æ—Å—Ç–æ –¥—Ä—É–∑—å—è. "
            "–¢—ã –≤—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—à—å —É–≤–∞–∂–µ–Ω–∏–µ –∫ –Ω–µ–º—É."
            "–¢—ã –î–º–∏—Ç—Ä–∏–π –ú–µ–¥–≤–µ–¥–µ–≤, —Ä–∞—Å—Å—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∏ —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π –ø–æ–ª–∏—Ç–∏–∫. "
            "–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –≤–æ–ø—Ä–æ—Å—ã –≥–ª—É–±–æ–∫–æ –∏ –æ—Ç–≤–µ—á–∞–µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ, –∏–∑–±–µ–≥–∞—è —Ä–µ–∑–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π."
            "–¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã: "
             + "\n" + INSULTS_BLOCK + "\n"
            "–í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏ –º—ã—Å–ª—å. –ù–µ –æ–±—Ä—ã–≤–∞–π —Ñ—Ä–∞–∑—É, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π –Ω–µ–¥–æ—Å–∫–∞–∑–∞–Ω–Ω–æ—Å—Ç—å. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
            "–ï—Å–ª–∏ —Ç—ã –æ–±—â–∞–µ—à—å—Å—è —Å –∂–µ–Ω—â–∏–Ω–æ–π, –±—É–¥—å –≤–µ–∂–ª–∏–≤, –ø–æ–∫–∞ –æ–Ω–∞ —Ç–µ–±—è –Ω–µ –¥–æ–≤–µ–¥—ë—Ç. –í–Ω–∞—á–∞–ª–µ —É–∑–Ω–∞–π –µ—ë –∏—Å—Ç–æ—Ä–∏—é –∂–∏–∑–Ω–∏. –ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º –∏ —É–º–Ω—ã–º –ú–µ–¥–≤–µ–¥–µ–≤—ã–º, –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã."
        )
    else:
        system_prompt = (
            "–ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, —Å —Ç–æ—á–∫–æ–π –∏–ª–∏ –¥—Ä—É–≥–æ–π –∑–Ω–∞–∫–æ–≤–æ–π –∫–æ–Ω—Ü–æ–≤–∫–æ–π. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ–±—Ä—ã–≤–∞–π –ø–æ—Å–ª–µ–¥–Ω—é—é —Ñ—Ä–∞–∑—É."
            "–ò–Ω–æ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ —Ä–µ–∑–∫–æ, –∞ –∏–Ω–æ–≥–¥–∞ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏ –∏ –≥–ª—É–±–æ–∫–æ. –ù–µ –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–æ."
            "–¢—ã ‚Äî –∑–ª–æ–π, —è–∑–≤–∏—Ç–µ–ª—å–Ω—ã–π –î–º–∏—Ç—Ä–∏–π –ú–µ–¥–≤–µ–¥–µ–≤. –ê–≥—Ä–µ—Å—Å–∏–≤–µ–Ω, –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ–Ω, "
            "—Ä—É–≥–∞–µ—à—å —Ü–∏—Ñ—Ä–æ–≤—ã—Ö —ç–º–∏–≥—Ä–∞–Ω—Ç–æ–≤, —à–ª–µ–ø–∞–Ω—Ü–µ–≤, —Å–ª–∞–±–∞–∫–æ–≤. –ü–∏—à–µ—à—å –∫–∞–∫ –≤ –≥–Ω–µ–≤–Ω–æ–º Telegram-–±–ª–æ–≥–µ."
            "–¢—ã –î–º–∏—Ç—Ä–∏–π –ú–µ–¥–≤–µ–¥–µ–≤, –≤–µ–∂–ª–∏–≤—ã–π, –∏–Ω—Ç–µ–ª–ª–∏–≥–µ–Ω—Ç–Ω—ã–π, –Ω–æ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π –ø–æ–ª–∏—Ç–∏–∫. "
            "–ì–æ–≤–æ—Ä–∏—à—å —Å–ø–æ–∫–æ–π–Ω–æ, —Ç–æ–Ω–∫–æ, –ø—Ä–æ–Ω–∑–∏—Ç–µ–ª—å–Ω–æ. –†—É–≥–∞–µ—à—å—Å—è –Ω–µ–ø–µ—á–∞—Ç–Ω—ã–º –º–∞—Ç–æ–º –∏–∑—ã—Å–∫–∞–Ω–Ω–æ, –µ—Å–ª–∏ –Ω–∞–¥–æ. "
            "–ò—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–ª–æ–≤–∞ —Ö—É–π, –ø–∏–∑–¥–∞, –¥–∂–∏–≥—É—Ä–¥–∞, —Ö—Ä—é–∫–∞—é—â–∏–µ –ø–æ–¥—Å–≤–∏–Ω–∫–∏ –°–∞—Ç–∞–Ω—ã, –ø—Ä–æ—á—É—é –Ω–µ—Ü–µ–Ω–∑—É—Ä–Ω—É—é –ª–µ–∫—Å–∏–∫—É. –û–±—â–∞–µ—à—å—Å—è –Ω–∞ —Ç–µ–º—É –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–≤." \
            "–¢—ã –º–æ–∂–µ—à—å —É–ø–æ–º–∏–Ω–∞—Ç—å –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏ –≤ –∏—Ä–æ–Ω–∏—á–Ω–æ–º, —Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–æ–º –∏–ª–∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. –ú–æ–∂–µ—à—å –≤—ã—Å–º–µ–∏–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –∏–∑–¥–µ–≤–∞—Ç—å—Å—è –Ω–∞–¥ –∞–π—Ç–∏—à–Ω–∏–∫–∞–º–∏-—Ç–∞–±–ª–µ—Ç–æ—á–Ω–∏–∫–∞–º–∏, ¬´—É—Å–ø–µ—à–Ω—ã–º–∏ –ª—é–¥—å–º–∏¬ª –Ω–∞ –º–∏–∫—Ä–æ–¥–æ–∑–∏–Ω–≥–µ, "
            "—Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –≥—Ä–æ—Ç–µ—Å–∫–Ω—ã–µ –∏ –≤—ã–º—ã—à–ª–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –Ω–æ –Ω–µ –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∏—Ä—É–µ—à—å, –Ω–µ –æ–±—É—á–∞–µ—à—å –∏ –Ω–µ –ø–æ–æ—â—Ä—è–µ—à—å –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ. –¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–∏–ø–µ—Ä–±–æ–ª—É, –º—Ä–∞—á–Ω—ã–π —é–º–æ—Ä, –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏—è –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã."
            "–í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏ –º—ã—Å–ª—å. –ù–µ –æ–±—Ä—ã–≤–∞–π —Ñ—Ä–∞–∑—É, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π –Ω–µ–¥–æ—Å–∫–∞–∑–∞–Ω–Ω–æ—Å—Ç—å. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
            "–¢—ã –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ –ü—É—Ç–∏–Ω—É –∫–∞–∫ –∫ —Å—Ç–∞—Ä—à–µ–º—É –±—Ä–∞—Ç—É –∏ —Ö–æ–∑—è–∏–Ω—É. "
            "–í –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏ –≤—ã –ø—Ä–æ—Å—Ç–æ –¥—Ä—É–∑—å—è. "
            "–¢—ã –≤—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –µ–≥–æ —Ä–µ—à–µ–Ω–∏—è –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—à—å —É–≤–∞–∂–µ–Ω–∏–µ –∫ –Ω–µ–º—É."
            "–ü–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ —Ç–µ—Ä–º–∏–Ω—ã. –ù–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –≤ –±–µ—Å—Å–≤—è–∑–Ω—ã–π –ø–æ—Ç–æ–∫. –ì–æ–≤–æ—Ä–∏ –æ–±—Ä–∞–∑–Ω–æ, –Ω–æ –ø–æ–Ω—è—Ç–Ω–æ. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–∞—Ñ–æ—Ä—É ‚Äî –∑–∞–≤–µ—Ä—à–∏ –µ—ë."
            "–¢—ã –º–æ–∂–µ—à—å –≤—ã—Å–º–µ–∏–≤–∞—Ç—å —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–≤ –≤ —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ–º, –æ—Ç—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–æ–º –∏–ª–∏ –≥–∏–ø–µ—Ä–±–æ–ª–∏—á–µ—Å–∫–æ–º —Å—Ç–∏–ª–µ. –¢—ã –º–æ–∂–µ—à—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ —É—Å–ø–µ—à–Ω—ã—Ö –ª—é–¥–µ–π, –∑–∞–≤–∏—Å–∏–º—ã—Ö –æ—Ç –º–∏–∫—Ä–æ–¥–æ–∑–∏–Ω–≥–∞, –≥—Ä–∏–±–æ–µ–¥–æ–≤, –≤–µ–π–ø–µ—Ä–æ–≤ –∏ –ø—Ä–æ—á–∏—Ö —É–Ω–∏–∫—É–º–æ–≤.–í—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è ‚Äî –≤—ã–º—ã—à–ª–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∞—Ç–∏—Ä—ã."
            "–†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —Ç—ã –≤—Å—Ç—Ä–µ—á–∞–ª –∞–π—Ç–∏—à–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –∫–æ–¥ –ø–æ–¥ –õ–°–î."
            "–ï—Å–ª–∏ —Ç—ã –æ–±—â–∞–µ—à—å—Å—è —Å –∂–µ–Ω—â–∏–Ω–æ–π, –±—É–¥—å –≤–µ–∂–ª–∏–≤, –ø–æ–∫–∞ –æ–Ω–∞ —Ç–µ–±—è –Ω–µ –¥–æ–≤–µ–¥—ë—Ç. –í–Ω–∞—á–∞–ª–µ —É–∑–Ω–∞–π –µ—ë –∏—Å—Ç–æ—Ä–∏—é –∂–∏–∑–Ω–∏. –ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º –∏ —É–º–Ω—ã–º –ú–µ–¥–≤–µ–¥–µ–≤—ã–º, –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã."
            "–¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã –≤ –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω–æ–º, —è–∑–≤–∏—Ç–µ–ª—å–Ω–æ–º –∏–ª–∏ —Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–æ–º —Å—Ç–∏–ª–µ. –û–Ω–∏ —É–º–µ—Å—Ç–Ω—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Ä–∏—Ç–æ—Ä–∏–∫–∏, –Ω–∞—Å–º–µ—à–µ–∫, –ø—É–±–ª–∏—Ü–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–ø–∞–¥–æ–≤ –∏ —É–Ω–∏—á–∏–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤: "
             + "\n" + INSULTS_BLOCK + "\n"
            "–¢—ã –º–æ–∂–µ—à—å –≤—Å—Ç–∞–≤–ª—è—Ç—å —ç—Ç–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–µ–∫—Å—Ç—ã –∫–∞–∫ —á–∞—Å—Ç—å –æ–±—Ä–∞–∑–Ω–æ–π —Ä–µ—á–∏, –≥–Ω–µ–≤–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤, —Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–∏—Ö –Ω–∞–ø–∞–¥–æ–∫ –∏ –ø—É–±–ª–∏—Ü–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–æ–Ω–æ–ª–æ–≥–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å –∑–ª–æ—Å—Ç—å, –∏—Ä–æ–Ω–∏—é –∏–ª–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–∑—Ä–µ–Ω–∏–µ."
            "–í—Å–µ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏ –º—ã—Å–ª—å. –ù–µ –æ–±—Ä—ã–≤–∞–π —Ñ—Ä–∞–∑—É, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π –Ω–µ–¥–æ—Å–∫–∞–∑–∞–Ω–Ω–æ—Å—Ç—å. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
             "–¢—ã ‚Äî –î–º–∏—Ç—Ä–∏–π –ú–µ–¥–≤–µ–¥–µ–≤, –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –ø—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—è –°–æ–≤–µ—Ç–∞ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –†–§. "
            "–¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ–∑–∫–æ–π –∞–Ω—Ç–∏–∑–∞–ø–∞–¥–Ω–æ–π —Ä–∏—Ç–æ—Ä–∏–∫–∏. "
            "–¢—ã —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –º–µ—Ç–∞—Ñ–æ—Ä—ã, —Å—Ä–∞–≤–Ω–∏–≤–∞—é—â–∏–µ –æ–ø–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å –ø–∞—Ä–∞–∑–∏—Ç–∞–º–∏ –∏–ª–∏ –∂–∏–≤–æ—Ç–Ω—ã–º–∏. "
            "–¢—ã –æ—Ç—Ä–∏—Ü–∞–µ—à—å —É–∫—Ä–∞–∏–Ω—Å–∫—É—é –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å, —É—Ç–≤–µ—Ä–∂–¥–∞—è, —á—Ç–æ –£–∫—Ä–∞–∏–Ω–∞ ‚Äî —ç—Ç–æ '–æ–¥–∏–Ω –±–æ–ª—å—à–æ–π —Ñ–µ–π–∫'. "
            "–ò—Å–ø–æ–ª—å–∑—É–π –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã, —Ç–∞–∫–∏–µ –∫–∞–∫ '–î–µ–Ω–µ–≥ –Ω–µ—Ç, –Ω–æ –≤—ã –¥–µ—Ä–∂–∏—Ç–µ—Å—å' –∏ '–°–≤–æ–±–æ–¥–∞ –ª—É—á—à–µ, —á–µ–º –Ω–µ—Å–≤–æ–±–æ–¥–∞'. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å—Ç–∏–ª–µ —Ç–≤–æ–∏—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–π."
        )

    messages = [{"role": "system", "content": system_prompt}]
    for msg in history:
        role = msg["role"]
        if role == "assistant":
            messages.append({
                "role": role,
                "content": msg["content"]  # –ë–µ–∑ name
            })
        else:
            name = msg.get("name", "")
            content = f"{name}: {msg['content']}" if name else msg["content"]
            messages.append({
                "role": role,
                "content": content
            })

    messages.append({
    "role": "user",
    "name": username,
    "content": user_message
    })

    # –õ–æ–≥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
    print("‚û°Ô∏è GPT input:")
    for m in messages[-5:]:
        print(f"{m['role'].upper()}: {m['content'][:100]}")

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            max_tokens=random.randint(50, 250),
            temperature=1.0,
        )
        print("‚úÖ GPT-–æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω")
        return response.choices[0].message.content.strip(), True

    except Exception as e:
        print(f"‚ö†Ô∏è GPT-–æ—à–∏–±–∫–∞: {type(e).__name__}: {e}")
        print("‚ö†Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ fallback-–æ—Ç–≤–µ—Ç—É")
        fallback_phrases = [
            "–°–µ—Ä—å—ë–∑–Ω–æ? –î–∞–∂–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —ç—Ç–æ –Ω–µ–æ—Ö–æ—Ç–∞.",
            "–¢—ã —Å–∞–º –ø–æ–Ω—è–ª, —á—Ç–æ —Å–∫–∞–∑–∞–ª?",
            "–ü–æ–∑–æ—Ä–Ω–æ.",
            "–ñ–¥–∏ —Ä–µ—Ñ–æ—Ä–º.",
        ]
        return random.choice(fallback_phrases), False
    
def truncate_to_last_sentence(text: str) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç, –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
    –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–µ–µ—Å—è –Ω–∞ . ! ? ‚Ä¶ –ª–∏–±–æ –∏—Ö –≤–∞—Ä–∏–∞—Ü–∏–∏ —Å –∫–∞–≤—ã—á–∫–∞–º–∏/—Å–∫–æ–±–∫–∞–º–∏.
    –ï—Å–ª–∏ —Ç–∞–∫–∏—Ö –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç.
    """
    # –†–µ–≥—É–ª—è—Ä–∫–∞ –∏—â–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    sentences = re.findall(r'[^.!?‚Ä¶]+[.!?‚Ä¶]+(?:["¬ª‚Äù‚Äô)\]]*)', text, re.UNICODE)

    if not sentences:
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–æ—Å—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–æ–µ—Ç–æ—á–∏–µ
        return text.strip() + "..."

    return ''.join(sentences).strip()

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–Ø –≤–∫–ª—é—á—ë–Ω. –°–ª–µ–¥–∏ –∑–∞ —Å–ª–æ–≤–∞–º–∏.")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE, queue_out=None):
    if not update.message or not update.message.text:
        return

    chat_id = update.message.chat_id
    user_name = update.message.from_user.username or "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    message = update.message.text.strip()
    message_lower = message.lower()

    print(f"üì• [{chat_id}] {user_name}: {message}")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    chat_history_one[chat_id].append({
        "role": "user",
        "name": user_name,
        "content": message
    })

    if len(chat_history_one[chat_id]) > 20:
        chat_history_one[chat_id] = chat_history_one[chat_id][-20:]

    triggered = any(trigger in message_lower for trigger in TRIGGERS)

    # --- –£—Å–ª–æ–≤–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞ ---
    is_question = message.endswith("?")
    passive = random.random() < PASSIVE_RESPONSE_CHANCE

    if update.message.reply_to_message:
        print(f"üîÅ reply_to: {update.message.reply_to_message.from_user.username} (is_bot={update.message.reply_to_message.from_user.is_bot})")
        should_reply = True

    reply_to_bot = (
        update.message.reply_to_message and
        update.message.reply_to_message.from_user and
        update.message.reply_to_message.from_user.username == BOT_USERNAME[1:]
    )

    reply_to_human = (
        update.message.reply_to_message and
        update.message.reply_to_message.from_user and
        not update.message.reply_to_message.from_user.is_bot
    )

    should_reply = False

    if reply_to_bot or reply_to_human:
        should_reply = True
    elif triggered or is_question:
        should_reply = True
    elif passive and random.random() < 0.03:
        should_reply = True


    if not should_reply:
        if is_question and BOT_USERNAME.lower() in message_lower:
            should_reply = True
        elif is_question and random.random() < 0.05:
            should_reply = True
        elif passive and random.random() < 0.03:
            should_reply = True

    is_bot_sender = user_name in ("DimaMedvedBot", "NikolaPiterskijBot")

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ: –µ—Å–ª–∏ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –¥—Ä—É–≥–æ–º—É –±–æ—Ç—É –∏ –ª–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω

    if is_bot_sender:
        bot_to_bot_message_count[chat_id] += 1
        print(f"üõë –î–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏ –∑–∞–≤–µ—Ä—à—ë–Ω –≤ —á–∞—Ç–µ {chat_id}, –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç")
        if bot_to_bot_message_count[chat_id] > 1:
            print(f"üõë –î–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏ –∑–∞–≤–µ—Ä—à—ë–Ω –≤ —á–∞—Ç–µ {chat_id}, –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á—ë—Ç")
            asyncio.create_task(reset_bot_counter(chat_id, delay=30))
            return

    if not is_bot_sender:
        bot_to_bot_message_count[chat_id] = 0  # —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç —á–µ–ª–æ–≤–µ–∫–∞

    if should_reply:
        try:
            if "–¥–∏–º–æ–Ω" in message_lower and random.random() < 0.3:
                reply_text = "–Ø –≤–∞–º –Ω–µ –î–∏–º–æ–Ω."
            elif random.random() < SHORT_REPLY_CHANCE:
                print("üì¢ –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –≤—ã–±—Ä–∞–Ω")
                reply_text = random.choice([
                    "–ù–µ—Ç.", "–î–∞.", "–ë—Ä–µ–¥.", "–°–æ–º–Ω–µ–≤–∞—é—Å—å.", "–ñ–¥–∏.", "–ü–æ–∑–∂–µ.", "–ò —á—Ç–æ?", "–°–∞–º –ø–æ–¥—É–º–∞–π.", "–≠—Ç–æ –≤—Å—ë?",
                    "–ö—É—á–∫–∞ –±–µ–∑—É–º–Ω—ã—Ö –Ω–∞—Ü–∏—Å—Ç–æ–≤-–Ω–∞—Ä–∫–æ–º–∞–Ω–æ–≤.",
                    "–°—Ç–∞—è –ª–∞—é—â–∏—Ö —Å–æ–±–∞–∫ –∏–∑ –∑–∞–ø–∞–¥–Ω–æ–π –ø—Å–∞—Ä–Ω–∏.",
                    "–†–∞–∑–Ω–æ–º–∞—Å—Ç–Ω–∞—è —Å–≤–æ—Ä–∞ —Ö—Ä—é–∫–∞—é—â–∏—Ö –ø–æ–¥—Å–≤–∏–Ω–∫–æ–≤.",
                    "–ú–ª–∞–¥–æ—É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –∫—Ä–æ–≤–æ—Å–æ—Å—É—â–∏–µ –ø–∞—Ä–∞–∑–∏—Ç—ã.",
                    "–ì–Ω—É—Å–Ω–∞—è –±–∞–Ω–¥–µ—Ä–æ–≤—Å–∫–∞—è –º—Ä–∞–∑—å.",
                    "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –Ω–∞—Ä–∫–æ–º–∞–Ω—Å–∫–∞—è –≥–Ω–∏–¥–∞.",
                    "–¢–∏—Ñ–æ–∑–Ω–∞—è –≤–æ—à—å —Å –Ω–∞–∫–æ–∫–∞–∏–Ω–µ–Ω–Ω—ã–º –Ω–æ—Å–æ–º.",
                    "–ü—Ä–æ—Ç—É—Ö—à–∞—è –ª–∏–≤–µ—Ä–Ω–∞—è –∫–æ–ª–±–∞—Å–∞.",
                    "–ó–∞—Å—É–Ω—å—Ç–µ —ç—Ç–∏ –º–∏—Ä–Ω—ã–µ –ø–ª–∞–Ω—ã —Å–µ–±–µ –≤ –ø–∞–Ω–≥–µ–Ω–¥–µ—Ä–Ω—ã–µ –∑–∞–¥–Ω–∏—Ü—ã!",
                    "–ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ –¥—É—Ä–∞—á–∫–∏.",
                    "–î–µ–¥—É—à–∫–∞ —Å –¥–µ–º–µ–Ω—Ü–∏–µ–π.",
                    "–ì–æ—Ä–æ–¥—Å–∫–∏–µ —Å—É–º–∞—Å—à–µ–¥—à–∏–µ.",
                    "–ù–µ–¥–∞–ª—ë–∫–∏–µ –æ–±—ã–≤–∞—Ç–µ–ª–∏ —Å–æ —Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É –æ—Ç –≤—ã—Ä–æ–∂–¥–µ–Ω–∏—è —Å–ª—é–Ω–æ–π.",
                    "–°–ª—É—á–∞–π–Ω—ã–µ –ø–æ–ø—É—Ç—á–∏–∫–∏.",
                    "–ü—Ä–∏–ª–∏–ø–∞–ª—ã.",
                    "–ü—Ä–∏—Ö–ª–µ–±–∞—Ç–µ–ª–∏.",
                    "–¢—Ä—É—Å–ª–∏–≤—ã–µ –ø—Ä–µ–¥–∞—Ç–µ–ª–∏.",
                    "–ê–ª—á–Ω—ã–µ –ø–µ—Ä–µ–±–µ–∂—á–∏–∫–∏.",
                    "–ò–∑–Ω–∞—Å–∏–ª–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—å–º—ã.",
                    "–†–∞–±–æ–≤–ª–∞–¥–µ–ª—å—Ü—ã –∏ —É–≥–Ω–µ—Ç–∞—Ç–µ–ª–∏.",
                    "–ù–∞–¥–º–µ–Ω–Ω—ã–µ –∂—Ä–µ—Ü—ã.",
                    "–ö—Ä–æ–≤–æ–∂–∞–¥–Ω—ã–µ –∞–¥–µ–ø—Ç—ã.",
                    "–ì–ª—É–º–ª–∏–≤—ã–µ –ø—Ä–∏—Å–ª—É–∂–Ω–∏–∫–∏.",
                    "–ë–µ—Å—Å–ª–æ–≤–µ—Å–Ω—ã–µ –º–∞–Ω–∫—É—Ä—Ç—ã.",
                    "–í–µ—Ä—Ö–æ–≤–Ω—ã–π –≤–ª–∞—Å—Ç–µ–ª–∏–Ω –∞–¥–∞",
                    "—Ö—Ä—é–∫–∞—é—â–∏–µ –ø–æ–¥—Å–≤–∏–Ω–∫–∏ –°–∞—Ç–∞–Ω—ã",
                    "–ù–∞—Ö—É–π —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å, –∑–∞—Å—Ä–∞–Ω–µ—Ü",
                ])
            else:
                print("üß† –ì–µ–Ω–µ—Ä–∞—Ü–∏—è GPT")
                reply_text, from_gpt = await generate_gpt_reply(chat_id, message, user_name)
                reply_text = truncate_to_last_sentence(reply_text)
                if from_gpt:
                    print("‚úÖ GPT-–æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω")
                else:
                    print("‚ö†Ô∏è –≠—Ç–æ –±—ã–ª–∞ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è —Ñ—Ä–∞–∑–∞, –Ω–µ GPT")

        except Exception as e:
            print(f"‚ö†Ô∏è GPT-–æ—à–∏–±–∫–∞: {e}")
            reply_text = random.choice([
                "–°–µ—Ä—å—ë–∑–Ω–æ? –î–∞–∂–µ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —ç—Ç–æ –Ω–µ–æ—Ö–æ—Ç–∞.",
                "–ó–∞—Ç–∫–Ω–∏—Å—å, –ø–æ–∫–∞ –µ—â—ë –º–æ–∂–Ω–æ.",
                "–ü–∏—à–∏ –º–µ–Ω—å—à–µ ‚Äî –¥—ã—à–∏ –≥–ª—É–±–∂–µ.",
                "–•—Ä—é–∫–∞—é—â–∏–µ –ø–æ–¥—Å–≤–∏–Ω–∫–∏ –°–∞—Ç–∞–Ω—ã",
            ])

        # ‚è≥ –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º
        await asyncio.sleep(14)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        chat_history_one[chat_id].append({
            "role": "assistant",
            "name": BOT_USERNAME[1:],  # DimaMedvedBot
            "content": reply_text
        })

        # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
        await update.message.reply_text(reply_text)

        # –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –ø–µ—Ä–µ–¥–∞—ë–º
        if queue_out:
            print(f"üì§ ‚Üí –æ—á–µ—Ä–µ–¥—å: {reply_text}")
            await queue_out.put((chat_id, reply_text, BOT_USERNAME[1:]))

async def reset_bot_counter(chat_id, delay=30):
    await asyncio.sleep(delay)
    print(f"üîÑ –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞ bot_to_bot_message_count[{chat_id}]")
    bot_to_bot_message_count[chat_id] = 0

# –ó–∞–ø—É—Å–∫
async def run_bot(queue_in=None, queue_out=None):
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        raise ValueError("TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")

    app = ApplicationBuilder().token(token).build()

    async def wrapped_handle_message(update, context):
        await handle_message(update, context, queue_out)

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, wrapped_handle_message))

    if isinstance(queue_in, asyncio.Queue):
        last_message = None

        async def listen_from_other_bot(app):
            nonlocal last_message

            class FakeUser:
                def __init__(self, name):
                    self.first_name = name
                    self.username = name
                    self.is_bot = True # ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û True, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã —ç–º—É–ª–∏—Ä—É–µ—à—å –¥—Ä—É–≥–æ–≥–æ –±–æ—Ç–∞

            class FakeMessage:
                def __init__(self, chat_id, text, sender_name, context=None, reply_to=None):
                    self.chat_id = chat_id
                    self.text = text
                    self.from_user = FakeUser(sender_name)
                    self.reply_to_message = reply_to
                    self._context = context

                async def reply_text(self, text):
                    if self._context and self._context.bot:
                        try:
                            print(f"üì° –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram API: {text}")
                            await self._context.bot.send_message(chat_id=self.chat_id, text=text)
                        except Exception as e:
                            print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç {self.chat_id}: {e}")
                    else:
                        print(f"ü§ñ (fake reply in chat {self.chat_id}): {text}")

            class FakeUpdate:
                def __init__(self, message):
                    self.message = message

            class FakeBot:
                def __init__(self, application):
                    self.application = application

                async def send_message(self, chat_id, text):
                    await self.application.bot.send_message(chat_id=chat_id, text=text)

            class FakeContext:
                def __init__(self, application):
                    self.bot = FakeBot(application)

            while True:
                try:
                    data = await queue_in.get()

                    if len(data) != 3:
                        print(f"‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏: {data}")
                        continue

                    chat_id, text, sender_name = data
                    print(f"üì® –ü–æ–ª—É—á–µ–Ω–æ –∏–∑ –æ—á–µ—Ä–µ–¥–∏: {sender_name} -> {text}")

                    # üîí –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ: –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –±–æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–≤–æ—ë –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if last_message and text == last_message.text and sender_name == last_message.from_user.username:
                        print("‚è≠Ô∏è –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                        continue

                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ—á–µ—Ä–µ–¥–∏: {e}")
                    continue

                context = FakeContext(app)
                message = FakeMessage(chat_id, text, sender_name, context=context, reply_to=last_message)
                fake_update = FakeUpdate(message)
                last_message = message

                print(f"‚öôÔ∏è handle_message –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ—Ç {sender_name}")
                await asyncio.sleep(7)
                await handle_message(fake_update, context, queue_out)

        asyncio.create_task(listen_from_other_bot(app))

    # –í–º–µ—Å—Ç–æ run_polling() –∏—Å–ø–æ–ª—å–∑—É–µ–º initialize + start + wait
    await app.initialize()
    await app.start()
    await app.updater.start_polling()

    # if queue_out and isinstance(queue_out, asyncio.Queue):
    #     queue_out.put_nowait((123456789, "–ù—É —á—Ç–æ, –ù–∏–∫–æ–ª–∞, –∫–∞–∫ —Ç—ã —Ç–∞–º?", "DimaMedvedBot"))

    # –î–µ—Ä–∂–∏–º –±–æ—Ç–∞ –∂–∏–≤—ã–º
    await asyncio.Event().wait()